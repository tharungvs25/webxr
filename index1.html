<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebXR VR Tumbler Assembly</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

  <style>
    body { margin: 0; }
    #ui {
      position: fixed;
      top: 20px;
      width: 100%;
      text-align: center;
      color: white;
      font-family: Arial;
    }
  </style>
</head>

<body>

<div id="ui">
  <h2 id="instruction">Press Trigger to Start</h2>
  <div style="width:60%;margin:auto;background:#444;height:10px;border-radius:10px;">
    <div id="progress" style="height:100%;width:0%;background:lime;border-radius:10px;"></div>
  </div>
</div>

<a-scene vr-mode-ui="enabled: true" background="color: #87CEEB">

  <!-- Better Lighting -->
  <a-light type="ambient" intensity="1.2"></a-light>
  <a-light type="directional" position="2 4 1" intensity="0.8"></a-light>
  <a-light type="point" position="0 2 -2" intensity="0.5"></a-light>

  <!-- Floor -->
  <a-plane rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>

  <!-- Table -->
  <a-box position="0 0.5 -1.5" width="1.5" height="0.1" depth="1.5" color="#8B4513"></a-box>

  <!-- Assembly Anchor -->
  <a-entity id="assembly" position="0 0.55 -1.5">

    <!-- CUP - sitting on table -->
    <a-entity id="cup"
      gltf-model="cup.gltf"
      scale="0.1 0.1 0.1"
      rotation="-90 0 0"
      position="0 0.05 0">
    </a-entity>

    <!-- CAP - starts on table next to cup -->
    <a-entity id="cap"
      gltf-model="cap.gltf"
      position="0.3 0.05 0"
      scale="0.1 0.1 0.1"
      rotation="-90 0 0">
    </a-entity>

  </a-entity>

  <!-- Reference Box to help visualize (you can remove this) -->
  <a-box position="0.3 0.6 -1.5" width="0.1" height="0.1" depth="0.1" color="red"></a-box>

  <!-- Right Controller -->
  <a-entity laser-controls="hand: right"></a-entity>

  <!-- Camera -->
  <a-entity camera look-controls position="0 1.6 0.3" rotation="0 0 0"></a-entity>

</a-scene>

<script>
let step = 0;

const instructions = [
  "Place the cup on the table",
  "Align the cap above the cup",
  "Lower the cap onto the cup",
  "Twist the cap clockwise",
  "Assembly Complete"
];

function speak(text){
  const msg = new SpeechSynthesisUtterance(text);
  msg.rate = 0.9;
  speechSynthesis.speak(msg);
}

function updateUI(){
  document.getElementById("instruction").innerText = instructions[step];
  document.getElementById("progress").style.width = (step/4)*100 + "%";
  speak(instructions[step]);
}

function nextStep(){

  if(step === 0){
    // Move cap to hover above cup
    document.querySelector("#cap").setAttribute("animation",
      "property: position; to: 0 0.3 0; dur: 1000; easing: easeInOutQuad;");
  }

  else if(step === 1){
    // Lower cap onto cup
    document.querySelector("#cap").setAttribute("animation",
      "property: position; to: 0 0.15 0; dur: 1000; easing: easeInOutQuad;");
  }

  else if(step === 2){
    // Twist animation
    document.querySelector("#cap").setAttribute("animation",
      "property: rotation; to: -90 360 0; dur: 1500; easing: linear;");
  }

  step++;

  if(step > 4) step = 4;

  updateUI();
}

// Controller trigger event
document.querySelector('a-scene').addEventListener('loaded', function(){
  const controllers = document.querySelectorAll('[laser-controls]');
  controllers.forEach(controller => {
    controller.addEventListener('triggerdown', function(){
      if(step < 4){
        nextStep();
      }
    });
  });
});

// Backup click for testing on desktop
window.addEventListener("click", nextStep);

updateUI();
</script>


</body>
</html>
